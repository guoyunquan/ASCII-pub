<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ›åšä¸çœŸè§†é¢‘ç”Ÿæˆå™¨</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #0a0a0a;
            color: #fff;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: #111;
            padding: 20px;
            text-align: center;
            font-size: 2rem;
            color: #ff6b35;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #00ffcc;
            color: #0a0a0a;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .back-button:hover {
            background-color: #008c73;
        }

        .container {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            flex-grow: 1;
        }

        .left-panel {
            width: 30%;
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .custom-select-container {
            position: relative;
            width: 100%;
        }

        .custom-select {
            background-color: #1a1a1a;
            border: 1px solid #ff6b35;
            border-radius: 8px;
            padding: 10px;
            font-size: 1rem;
            color: #ff6b35;
            cursor: pointer;
            user-select: none;
            position: relative;
            z-index: 3;
        }

        .custom-select:hover {
            border-color: #ff8c5a;
        }

        .custom-select-options {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background-color: #1a1a1a;
            border: 1px solid #ff6b35;
            border-radius: 8px;
            display: none;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(255, 107, 53, 0.3);
        }

        .custom-select-options.active {
            display: block;
        }

        .custom-select-options div {
            padding: 10px;
            color: #ff6b35;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .custom-select-options div:hover {
            background-color: #ff6b35;
            color: #1a1a1a;
        }

        .drag-area {
            flex-grow: 1;
            background-color: #333;
            border: 2px dashed #ff6b35;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-top: 20px;
        }

        .drag-area.disabled {
            cursor: not-allowed;
            background-color: #555;
            border-color: #888;
        }

        .upload-icon {
            font-size: 3rem;
            color: #ff6b35;
            margin-bottom: 15px;
            display: block;
        }

        .drag-area p {
            color: #888;
            margin-bottom: 8px;
        }

        .drag-area .subtitle {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .input-container input[type="file"] {
            display: none;
        }

        .input-container label {
            padding: 12px 24px;
            background-color: #ff6b35;
            color: #0a0a0a;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .input-container label:hover {
            background-color: #e55a2b;
        }

        .generate-button {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            background-color: #ff6b35;
            color: #0a0a0a;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }

        .generate-button[disabled] {
            background-color: #555;
            cursor: not-allowed;
        }

        .right-panel {
            width: 65%;
            background-color: #1a1a1a;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .progress-container {
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid #ff6b35;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #ffaa80);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #ff6b35;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .status-text {
            text-align: center;
            color: #888;
            font-size: 0.9rem;
        }



        .original-video {
            display: none;
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 255, 204, 0.3);
            margin-bottom: 20px;
        }

        .original-video.show {
            display: block;
        }



        .placeholder-text {
            color: #666;
            font-size: 1.2rem;
            text-align: center;
        }
    </style>
</head>

<body>
<header>
    <button class="back-button" onclick="window.location.href='index.html'">è¿”å›</button>
    èµ›åšä¸çœŸè§†é¢‘ç”Ÿæˆå™¨
</header>

<div class="container">
    <div class="left-panel">
        <div class="form-group">
            <label>è½¬æ¢è´¨é‡</label>
            <div class="custom-select-container">
                <div class="custom-select" id="qualitySelect">æ ‡å‡†</div>
                <div class="custom-select-options" id="qualityOptions"></div>
            </div>
        </div>
        <div class="form-group">
            <label>å­—ç¬¦å¯†åº¦</label>
            <div class="custom-select-container">
                <div class="custom-select" id="densitySelect">ä¸­ç­‰</div>
                <div class="custom-select-options" id="densityOptions"></div>
            </div>
        </div>
        <div class="form-group">
            <label>å°çª—å¤§å°</label>
            <div class="custom-select-container">
                <div class="custom-select" id="opacitySelect">30%</div>
                <div class="custom-select-options" id="opacityOptions"></div>
            </div>
        </div>
        <div class="drag-area" id="drag-area">
            <!-- <div class="upload-icon">ğŸ¬</div> -->
            <p>æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„</p>
            <div class="subtitle">æ”¯æŒ MP4, AVI, MOV ç­‰æ ¼å¼</div>
            <div class="input-container">
                <input type="file" id="fileInput" accept="video/*" />
                <label for="fileInput">é€‰æ‹©è§†é¢‘æ–‡ä»¶</label>
            </div>
        </div>
        <button class="generate-button" id="generateButton" disabled>å¼€å§‹ç”ŸæˆASCIIè§†é¢‘</button>
    </div>

    <div class="right-panel">
        <!-- åŸè§†é¢‘é¢„è§ˆ -->
        <video class="original-video" id="originalVideo" controls>
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
        </video>
        
        <!-- è¿›åº¦æ˜¾ç¤º -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status-text" id="statusText">ç­‰å¾…å¼€å§‹...</div>
        </div>
        

        
        <!-- å ä½æ–‡æœ¬ -->
        <div class="placeholder-text" id="placeholderText">
            é€‰æ‹©è§†é¢‘æ–‡ä»¶å¼€å§‹ç”ŸæˆASCIIè‰ºæœ¯è§†é¢‘
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const qualitySelect = document.getElementById("qualitySelect");
        const qualityOptions = document.getElementById("qualityOptions");
        const densitySelect = document.getElementById("densitySelect");
        const densityOptions = document.getElementById("densityOptions");
        const opacitySelect = document.getElementById("opacitySelect");
        const opacityOptions = document.getElementById("opacityOptions");
        const fileInput = document.getElementById("fileInput");
        const dragArea = document.getElementById("drag-area");
        const generateButton = document.getElementById("generateButton");
        const progressContainer = document.getElementById("progressContainer");
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");
        const statusText = document.getElementById("statusText");
        const originalVideo = document.getElementById("originalVideo");
        const placeholderText = document.getElementById("placeholderText");

        let selectedFile = null;
        let websocket = null;
        let isGenerating = false;

        // é€‰æ‹©æ¡†é…ç½®
        const qualityMapping = {
            "ç®€å•": "simple",
            "æ ‡å‡†": "complex"
           
        };

        const densityMapping = {
            "ä½": "60",
            "ä¸­ç­‰": "80", 
            "é«˜": "120",
            "è¶…é«˜": "160"
        };

        const opacityMapping = {
            "10%": "0.1",
            "20%": "0.2",
            "30%": "0.3",
            "40%": "0.4",
            "50%": "0.5"
        };

        // åˆå§‹åŒ–é€‰æ‹©æ¡†
        function populateOptions(container, options) {
            container.innerHTML = "";
            options.forEach(option => {
                const div = document.createElement("div");
                div.textContent = option;
                div.dataset.value = option;
                container.appendChild(div);
            });
        }

        function setupCustomSelect(select, optionsContainer, callback) {
            select.addEventListener("click", () => {
                if (!isGenerating) {
                    optionsContainer.classList.toggle("active");
                }
            });

            optionsContainer.addEventListener("click", (event) => {
                if (event.target.dataset.value && !isGenerating) {
                    select.textContent = event.target.textContent;
                    optionsContainer.classList.remove("active");
                    callback(event.target.dataset.value);
                }
            });

            document.addEventListener("click", (event) => {
                if (!select.contains(event.target) && !optionsContainer.contains(event.target)) {
                    optionsContainer.classList.remove("active");
                }
            });
        }

        // è®¾ç½®é€‰æ‹©æ¡†
        populateOptions(qualityOptions, Object.keys(qualityMapping));
        populateOptions(densityOptions, Object.keys(densityMapping));
        populateOptions(opacityOptions, Object.keys(opacityMapping));

        setupCustomSelect(qualitySelect, qualityOptions, (selectedQuality) => {
            console.log("é€‰ä¸­çš„è´¨é‡:", selectedQuality);
        });

        setupCustomSelect(densitySelect, densityOptions, (selectedDensity) => {
            console.log("é€‰ä¸­çš„å¯†åº¦:", selectedDensity);
        });

        setupCustomSelect(opacitySelect, opacityOptions, (selectedOpacity) => {
            console.log("é€‰ä¸­çš„é€æ˜åº¦:", selectedOpacity);
        });

        // æ–‡ä»¶æ‹–æ‹½å¤„ç†
        dragArea.addEventListener("dragover", (event) => {
            event.preventDefault();
            if (!isGenerating) {
                dragArea.style.borderColor = "#ff6b35";
            }
        });

        dragArea.addEventListener("dragleave", () => {
            dragArea.style.borderColor = "#ff6b35";
        });

        dragArea.addEventListener("drop", (event) => {
            event.preventDefault();
            if (isGenerating) return;
            
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith("video/")) {
                handleFileSelect(file);
            } else {
                alert("è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼");
            }
        });

        fileInput.addEventListener("change", (event) => {
            if (isGenerating) return;
            
            const file = event.target.files[0];
            if (file && file.type.startsWith("video/")) {
                handleFileSelect(file);
            } else {
                alert("è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼");
            }
        });

        // ç‚¹å‡»æ–‡ä»¶è¾“å…¥æ¡†æ—¶é‡ç½®valueï¼Œç¡®ä¿ç›¸åŒæ–‡ä»¶ä¹Ÿèƒ½è§¦å‘changeäº‹ä»¶
        fileInput.addEventListener("click", () => {
            if (!isGenerating) {
                fileInput.value = "";
            }
        });

        function handleFileSelect(file) {
            selectedFile = file;
            generateButton.disabled = false;
            
            // é‡Šæ”¾ä¹‹å‰çš„è§†é¢‘URLï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (originalVideo.src && originalVideo.src.startsWith('blob:')) {
                URL.revokeObjectURL(originalVideo.src);
            }
            
            // æ˜¾ç¤ºåŸè§†é¢‘é¢„è§ˆ
            const videoURL = URL.createObjectURL(file);
            originalVideo.src = videoURL;
            originalVideo.classList.add("show");
            
            // å¼ºåˆ¶é‡æ–°åŠ è½½è§†é¢‘
            originalVideo.load();
            
            // éšè—å ä½æ–‡æœ¬
            placeholderText.style.display = "none";
            
            // é‡ç½®å…¶ä»–ç•Œé¢å…ƒç´ 
            progressContainer.classList.remove("show");
            
            // æ¸…ç†ä¹‹å‰çš„çŠ¶æ€
            placeholderText.textContent = "";
        }

        function toggleGenerating(state) {
            isGenerating = state;
            generateButton.disabled = state;
            dragArea.classList.toggle("disabled", state);
            fileInput.disabled = state;
            
            // ç¦ç”¨é€‰æ‹©æ¡†
            qualitySelect.style.pointerEvents = state ? "none" : "auto";
            densitySelect.style.pointerEvents = state ? "none" : "auto";
            opacitySelect.style.pointerEvents = state ? "none" : "auto";
            qualitySelect.style.opacity = state ? "0.5" : "1";
            densitySelect.style.opacity = state ? "0.5" : "1";
            opacitySelect.style.opacity = state ? "0.5" : "1";
            
            if (state) {
                generateButton.textContent = "ç”Ÿæˆä¸­...";
                // éšè—åŸè§†é¢‘ï¼Œæ˜¾ç¤ºè¿›åº¦
                originalVideo.classList.remove("show");
                // æ¸…ç†ä¹‹å‰çš„çŠ¶æ€æ–‡æœ¬
                placeholderText.style.display = "none";
                placeholderText.textContent = "";
                // é‡ç½®è¿›åº¦æ¡çŠ¶æ€
                progressFill.style.width = "0%";
                progressText.textContent = "0%";
                statusText.textContent = "å‡†å¤‡å¼€å§‹...";
            } else {
                generateButton.textContent = "å¼€å§‹ç”ŸæˆASCIIè§†é¢‘";
            }
        }

        function connectWebSocket(taskId) {
            
            const wsUrl = `wss://ascii.gyq-me.top/video/ws/${taskId}`;
            // const wsUrl = `ws://localhost:8000/video/ws/${taskId}`;
            websocket = new WebSocket(wsUrl);

            websocket.onopen = () => {
                console.log("WebSocketè¿æ¥å·²å»ºç«‹");
                progressContainer.classList.add("show");
            };

            websocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log("æ”¶åˆ°æ¶ˆæ¯:", data);

                    if (data.type === "progress") {
                        // ç¡®ä¿progresså€¼åœ¨åˆç†èŒƒå›´å†…
                        let progress = Math.round(Math.max(0, Math.min(100, data.progress || 0)));
                        
                        console.log(`è¿›åº¦æ›´æ–°: ${progress}%`);
                        
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `${progress}%`;
                        statusText.textContent = data.message || "å¤„ç†ä¸­...";
                        
                        // ç¡®ä¿è¿›åº¦æ¡ä»ç„¶å¯è§
                        if (!progressContainer.classList.contains("show")) {
                            progressContainer.classList.add("show");
                        }
                        
                    } else if (data.type === "completed") {
                        console.log("ä»»åŠ¡å®Œæˆï¼Œå‡†å¤‡æ˜¾ç¤ºè§†é¢‘");
                        
                        progressFill.style.width = "100%";
                        progressText.textContent = "100%";
                        statusText.textContent = "å®Œæˆï¼";
                        
                        // éšè—è¿›åº¦æ¡
                        setTimeout(() => {
                            progressContainer.classList.remove("show");
                            
                            console.log("è®¾ç½®è§†é¢‘URL:", data.video_url);
                            
                            // å°†ç”Ÿæˆçš„ASCIIè§†é¢‘æ˜¾ç¤ºåœ¨åŸä½ç½®
                            originalVideo.src = data.video_url;
                            originalVideo.classList.add("show");
                            
                            // æ·»åŠ è§†é¢‘åŠ è½½äº‹ä»¶ç›‘å¬
                            originalVideo.onloadeddata = () => {
                                console.log("ASCIIè§†é¢‘åŠ è½½æˆåŠŸ");
                                // è§†é¢‘åŠ è½½æˆåŠŸï¼Œä¸éœ€è¦æ˜¾ç¤ºé¢å¤–æç¤º
                                placeholderText.style.display = "none";
                            };
                            
                            originalVideo.onerror = (e) => {
                                console.error("è§†é¢‘åŠ è½½å¤±è´¥:", e);
                                placeholderText.textContent = "è§†é¢‘é¢„è§ˆå¤±è´¥ï¼Œä½†æ–‡ä»¶å·²ä¸‹è½½æˆåŠŸ";
                                placeholderText.style.display = "block";
                                placeholderText.style.color = "#ff6b35";
                            };
                            
                            // å¼ºåˆ¶é‡æ–°åŠ è½½è§†é¢‘
                            originalVideo.load();
                            
                        }, 1000);
                        
                        toggleGenerating(false);
                        websocket.close();
                        
                    } else if (data.type === "error") {
                        console.error("ä»»åŠ¡é”™è¯¯:", data.message);
                        statusText.textContent = `é”™è¯¯: ${data.message}`;
                        toggleGenerating(false);
                        websocket.close();
                        
                    } else {
                        console.warn("æœªçŸ¥æ¶ˆæ¯ç±»å‹:", data.type, data);
                    }
                    
                } catch (error) {
                    console.error("è§£æWebSocketæ¶ˆæ¯å¤±è´¥:", error, event.data);
                    statusText.textContent = "æ¶ˆæ¯è§£æé”™è¯¯";
                }
            };

            websocket.onerror = (error) => {
                console.error("WebSocketé”™è¯¯:", error);
                statusText.textContent = "è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•";
                toggleGenerating(false);
            };

            websocket.onclose = () => {
                console.log("WebSocketè¿æ¥å·²å…³é—­");
            };
        }

        generateButton.addEventListener("click", async () => {
            if (!selectedFile || isGenerating) {
                return;
            }

            toggleGenerating(true);

            const quality = qualityMapping[qualitySelect.textContent.trim()];
            const density = densityMapping[densitySelect.textContent.trim()];
            const opacity = opacityMapping[opacitySelect.textContent.trim()];

            const formData = new FormData();
            formData.append("file", selectedFile);
            formData.append("overlay_ratio", opacity);
            formData.append("mode", quality);
            formData.append("num_cols", density);

            try {
                const response = await fetch("https://ascii.gyq-me.top/video/convert_video_ws", {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    throw new Error("å¯åŠ¨è§†é¢‘è½¬æ¢å¤±è´¥ï¼");
                }

                const result = await response.json();
                const taskId = result.task_id;
                
                // è¿æ¥WebSocketç›‘å¬è¿›åº¦
                connectWebSocket(taskId);

            } catch (error) {
                alert(`ç”Ÿæˆå¤±è´¥ï¼š${error.message}`);
                toggleGenerating(false);
            }
        });
    });
</script>
</body>

</html> 