# 🎵 ASCII视频生成器 - 音频处理功能

## 功能说明

现在视频转换器支持保留原始视频的音频轨道！生成的ASCII视频将包含原始音频，提供完整的视听体验。

## 🚀 快速开始

### 1. 安装依赖

首先确保服务器环境有 FFmpeg：

```bash
# 给脚本执行权限
chmod +x install_ffmpeg.sh

# 运行安装脚本
./install_ffmpeg.sh
```

### 2. 功能特性

✅ **自动音频检测**：自动检测原视频是否包含音频轨道  
✅ **智能合并**：使用 FFmpeg 将ASCII视频与原始音频完美合并  
✅ **格式兼容**：支持 MP4, AVI, MOV 等常见视频格式  
✅ **错误处理**：如果音频合并失败，仍保留无音频的ASCII视频  
✅ **进度提示**：WebSocket 实时显示音频处理进度  

### 3. 处理流程

```
📥 上传视频
     ↓
🎨 生成ASCII视频 (无音频)
     ↓
🔍 检测原视频音频
     ↓
🎵 合并音频 (如果存在)
     ↓
📤 输出最终视频 (带音频)
```

## 🛠️ 技术实现

### 后端处理逻辑

1. **视频处理**：使用 OpenCV 生成ASCII视频帧
2. **音频检测**：使用 FFprobe 检查原视频是否包含音频流
3. **音频合并**：使用 FFmpeg 将ASCII视频与原始音频合并

### FFmpeg 命令

```bash
ffmpeg -i ascii_video.mp4 -i original_video.mp4 \
       -c:v copy -c:a aac \
       -map 0:v -map 1:a? \
       -shortest -y output_with_audio.mp4
```

参数说明：
- `-c:v copy`：复制视频流，不重新编码
- `-c:a aac`：音频编码为AAC格式
- `-map 0:v`：使用第一个输入的视频流
- `-map 1:a?`：使用第二个输入的音频流（如果存在）
- `-shortest`：以最短流为准

## 🔧 环境要求

- **FFmpeg** >= 4.0
- **FFprobe** (通常随FFmpeg一起安装)
- **Python** >= 3.8
- **FastAPI**
- **OpenCV**

## 📊 性能优化

- 音频合并使用流复制，无需重新编码视频
- 支持并行处理，不影响视频生成速度
- 自动清理临时文件，节省存储空间

## 🐛 故障排除

### 常见问题

**Q: 生成的视频没有音频怎么办？**
A: 检查以下几点：
1. 确认原视频包含音频轨道
2. 确认服务器已安装 FFmpeg
3. 查看服务器日志中的音频处理信息

**Q: FFmpeg 安装失败怎么办？**
A: 
- Ubuntu/Debian: `sudo apt-get install ffmpeg`
- CentOS/RHEL: `sudo yum install epel-release && sudo yum install ffmpeg`
- macOS: `brew install ffmpeg`

**Q: 音频合并失败但视频生成成功？**
A: 这是正常的降级处理，你仍然可以获得无音频的ASCII视频

### 日志信息

查看控制台输出，了解音频处理状态：

```
🔍 检查原视频是否包含音频...
✅ 原视频包含音频，开始合并...
🎵 开始合并音频...
✅ 音频合并成功！
🎉 音频合并成功！最终文件: data/xxx_with_audio.mp4
```

## 🎯 使用提示

1. **视频格式**：推荐使用 MP4 格式，兼容性最好
2. **音频质量**：音频将编码为 AAC 格式，确保广泛兼容
3. **文件大小**：带音频的视频文件会比纯ASCII视频稍大
4. **处理时间**：音频合并通常只需几秒钟

## 🔮 未来计划

- [ ] 支持音频效果处理（回声、变调等）
- [ ] 支持多音轨视频
- [ ] 支持音频格式转换选项
- [ ] 音频可视化同步

---

> 现在你的ASCII视频不仅有酷炫的视觉效果，还有完整的音频体验！🎵✨ 